workflow:
  rules:
    - changes:
        - server/**/*
        - .gitlab-ci.yml
    - when: never

stages:
  - test
  - build

variables:
  MARIADB_ROOT_PASSWORD: "root"
  MYSQL_DATABASE: "tam"
  DB_HOST: "mariadb"
  REDIS_HOST: "redis"
  DOCKER_DRIVER: overlay2

services:
  - name: mariadb:latest
    alias: mariadb
    command:
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_uca1400_as_ci"
  - name: redis:latest
    alias: redis
    command: redis-server --requirepass root

before_script:
  - apt-get update && apt-get install -y python3-pip python3-venv
  - python3 -m venv venv
  - source venv/bin/activate
  - pip install pytest pytest-dependency
  - pip install -r server/app/requirements.txt

test:
  stage: test
  script:
    - cd server
    - pytest --junitxml=pytest-report.xml
  artifacts:
    reports:
      junit: server/pytest-report.xml

docker_build:
  stage: build
  image: docker:latest
  rules:
    - if: '$CI_COMMIT_REF_NAME == "develop"'
      changes:
        - server/app/**/*
    - when: never
  before_script: []
  services:
    - name: docker:dind
      command: ["--tls=false"]
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "$CI_REGISTRY_IMAGE/backend-dev:latest" server/app/
    - docker push "$CI_REGISTRY_IMAGE/backend-dev:latest"
